# sd-webui-auto-operation

## **Attention**

**This is not an extension of stable-diffusion-webui**

**これは stable-diffusion-webui の拡張機能ではありません。**

<br>

[日本語の説明は下部に記載してあります。](#jump)

<br>

## **About**

This is a script to assist in the automatic operation of [AUTOMATIC1111 / stable-diffusion-webui](https://github.com/AUTOMATIC1111/stable-diffusion-webui), using the E2E testing tool [Playwright](https://playwright.dev/) and javaScript.Some knowledge of javascript is required to create an original automated process.

**This video shows i2i being performed on all images output by t2i.(2X speed)**

![sample](https://github.com/nefudev/sd-webui-auto-operation/assets/132149510/8784eeb0-59e2-4560-9cd2-5c0b304380eb)

<br>

## **Features**

- The following operations are available as sample code

  - Execute t2i once with any parameter
  - Enable hiresFix with any parameter and run t2i once
  - Execute t2i with any parameter a specified number of times
  - Execute t2i with any parameter and then execute i2i on the generated image

- Possible to create original automation scenarios (script writing is required)
- Automation by operating extensions is possible (script writing required)
- Automation scenarios can be created by recording GUI operations
- Headless (browser hidden) automation (may be slightly faster...?)

Basically, you need to code according to what you want to automate
Execution is also confirmed to work with commit ID: 22bcc7be428c94e9408f589966c2040187245d81.

<br>

## **Install**

1. Installing a version control tool for node.js

   This program uses [volta](https://volta.sh/) for version control of node.js. Please install from the official site.

2. Create a clone in any directory

   Execute the following command from the terminal

```
git clone https://github.com/nefudev/sd-webui-auto-operation.git
```

3. Installing packages

   Go to the cloned directory and execute the following from the terminal

```
npm i
```

4. Installing Visual Studio Code

   [Visual Studio Code](https://code.visualstudio.com/) is useful for executing automatic processes, setting parameters, and writing original automatic processes.

<br>

## **Test run (one t2i run with any parameters)**

This command is for those who want to try it for the time being. txt2img is executed once with the set parameters.

1. Start sd-webui and make sure it is ready to generate images.
2. Execute the following command from the terminal in the sd-webui-auto-operation directory

```
npm run executeT2iOnce
```

For actual execution, it is convenient to run with Visual Studio Code.

It is recommended to use the [plawright extension for Visual Studio Code](https://marketplace.visualstudio.com/items?itemName=ms-playwright.playwright).

<br>

## **Directory**

```
sd-webui-auto-operation/
- src
- const/               # Stores fixed values, etc.
      - config.ts      # Parameter configuration file
      - extLocators.ts # Elements for extended functions
      - locators.ts    # Elements for default functions
      - prompts.ts
   - tests/            # Stores files describing automatic processing
      - sample.spec.ts
   - utils/            # Contains files describing processing for each function
      - utils.ts       # functions needed to automate t2i and i2i
- package.json
- playwright.config.ts
- README.md
```

## **Configure parameters**

- Parameters such as prompt and size can be set in config.ts.

<br>

## **How to Create an Automatic Process**

Brief explanation!

- Automatic processing takes a target element, such as a button or input form, and clicks on it or inputs text.

- Elements can be specified using Playwright's functionality, XPath, or other methods.

- The target element information is described in locators.ts and extLocators.ts using XPath.

- To create an original auto-execution process, refer to the sample and describe it in the test method in the \*.spec.ts file.

- The methods required for t2i and i2i automation are summarized in utils.ts. Some excerpts of the functions are listed below.
  - Input prompt
  - Image generation
  - Checkpointing
  - Sampler settings
  - Batch settings
- Basically, it uses Playwright's functions, so we recommend that you read the [references](https://playwright.dev/docs/intro).

<br>

## **How to record UI operations**

Playwright has the ability to record screen operations and create tests. By using this function, you can easily create automated processes.

1. Execute the following command from a terminal in the sd-webui-auto-operation directory

```
npm run codegen http://localhost:7860/
```

2. check the window to be automated and the display of the "Playwright Inspector" window
3. operate and record the screen
4. paste the code generated by "Playwright Inspector" into the file \*.spec.ts

This method is easy to create an automatic process, but it is not suitable for creating precise or complex automatic processes.

<br>

## **Notes**

- This script performs automated processing based on screen information. Therefore, it may not work if elements of the stable-diffusion-webui screen are changed in the future.

<br>
<br>

**下記から日本語の説明**

---

<br>

## **このスクリプトについて**

これは[AUTOMATIC1111 / stable-diffusion-webui](https://github.com/AUTOMATIC1111/stable-diffusion-webui)の自動操作の支援スクリプトです。E2E テストツールの [Playwright](https://playwright.dev/) と javaScript を使用しています。オリジナルの自動化処理を作成するためには、javaScript の知識がある程度必要です。

<br>

## **できること**

- サンプルコードとして下記操作が可能

  - 任意のパラメーターで t2i を 1 回実行
  - 任意のパラメーターで hiresFix 有効にして t2i を 1 回実行
  - 任意のパラメーターで t2i を指定回数実行
  - 任意のパラメーターで t2i を実行し、生成した画像に対して i2i を実行

- オリジナルの自動化シナリオを作成が可能(スクリプト記述が必要)
- 拡張機能を操作しての自動化が可能(スクリプト記述が必要)
- GUI 操作を記録して自動化シナリオの作成が可能
- ヘッドレス(ブラウザ非表示)で自動実行が可能(ほんの僅かに速くなるかも…？)

基本的に自動化したい内容に合わせて自分で作る感じになります。結構複雑な処理の自動化も可能なのかなと思っています。

また、実行はコミット ID:22bcc7be428c94e9408f589966c2040187245d81 で動作確認しています。

<br>

## **インストール**

1. node.js のバージョン管理ツールのインストール

   node.js のバージョン管理に[volta](https://volta.sh/)を使用しています。公式サイトからインストールしてください。

   > 参考: [Node.js バージョン管理 Volta を Windows にインストールする](https://zenn.dev/longbridge/articles/30c70144c97d32)

2. 任意のディレクトリでクローン

   ターミナルから下記コマンドを実行

```
git clone https://github.com/nefudev/sd-webui-auto-operation.git
```

3. パッケージのインストール

   クローンしたディレクトリに移動してターミナルより下記を実行

```
npm i
```

4. Visual Studio Code のインストール

   自動処理の実行やパラメーターの設定、オリジナルの自動処理を記述する場合、[Visual Studio Code](https://code.visualstudio.com/)があると便利です。

<br>

## **テスト実行 (任意のパラメーターで t2i を 1 回実行)**

とりあえずすぐ使って見たい人用コマンド。設定されたパラメーターで txt2img が 1 回実行されます。

1. sd-webui の起動し、画像生成できる状態にしておく
2. sd-webui-auto-operation ディレクトリ内でターミナルから下記コマンドを実行

```
npm run executeT2iOnce
```

実際の実行には Visual Studio Code で実行するのが便利です。

[Visual Studio Code 向けの plawright の拡張](https://marketplace.visualstudio.com/items?itemName=ms-playwright.playwright)を利用するのがおすすめです。

<br>

## **ディレクトリ構成**

```
sd-webui-auto-operation/
- src
   - const/             # 固定値等格納(実際は固定値以外もある…)
      - config.ts       # 各種パラメーター設定ファイル
      - extLocators.ts  # 拡張機能用の要素群
      - locators.ts     # デフォルト機能の要素群
      - prompts.ts　　　# よく使うプロンプト記載ファイル(のつもり)
   - tests/             # 自動処理記述したファイルを格納
      - sample.spec.ts
   - utils/             # 機能毎の処理を記述したファイルを格納
      - utils.ts        # t2iやi2iの自動化に必要な関数群
- package.json
- playwright.config.ts
- README.md
```

## **パラメーターの設定**

- プロンプトやサイズとかのパラメーターの設定は config.ts で行えます。

<br>

## **自動処理の作成方法**

ざっくり説明！

- 自動処理はボタンや入力フォーム等の対象の要素を取得して、クリックや文字入力などを行っています。
- 要素の指定には[Playwright の機能を使用](https://playwright.dev/docs/api/class-locator)するか、XPath を用いる方法などがあります。
- locators.ts や extLocators.ts には対象の要素情報を XPath で記述してあります。

- オリジナルの自動実行処理の作成はサンプルを参考に、\*.spec.ts のファイル内で test メソッド内に記述してください。
- t2i や i2i の自動化に必要なメソッドは utils.ts にまとめてあります。下記に機能の一部抜粋。
  - プロンプトの入力
  - 画像生成
  - チェックポイント設定
  - サンプラー設定
  - バッチ設定
- 基本的に Playwright の機能を使用しているので、[リファレンス](https://playwright.dev/docs/intro)等を読む事をおすすめします。

<br>

## **GUI の操作記録機能を使用して自動処理の作成**

Playwright には画面操作を記録して、テストを作成する機能があります。その機能を利用すれば、簡単に自動処理を作成する事ができます。

1. sd-webui-auto-operation ディレクトリ内でターミナルから下記コマンドを実行

```
npm run codegen http://localhost:7860/
```

2. 自動化対象のウィンドウと"Playwright Inspector"ウィンドウの表示を確認
3. 画面を操作して記録
4. "Playwright Inspector"に生成されたコードを\*.spec.ts に貼り付ける

※この方法は簡単に自動処理を作成出来ますが、精密さや複雑な自動処理の作成には向きません

<br>

## **注意点**

- このスクリプトは html の要素を元にボタンのクリックや入力を行っています。その為、今後 stable-diffusion-webui の画面の要素に変化があれば機能しなくなる事があります。
